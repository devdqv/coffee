
@{
    ViewBag.Title = "ThemSanPham";
    Layout = "~/Views/Shared/_LayoutQuanTri.cshtml";
}

<script>
    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#blah')
                    .attr('src', e.target.result);
            };

            reader.readAsDataURL(input.files[0]);
        }
    }

    $(document).ready(function () {
        //click Chọn ảnh sản phẩm
        $('.chooseImage').click(function () {
            $('input[type=file]').trigger('click');
        });

        //click nút thêm để mở form thêm
        $('#themLoaiSP').click(function (e) {
            e.preventDefault();
            var htmlFrm = $.ajax({
                method: 'GET',
                url: "/QuanTriSP_62134455/ThemDanhMuc",
                success: function (viewHtml) {
                    openModal("Thêm danh mục", $(viewHtml).html());
                }
            })
        })


        //click nút Lưu lại để lưu danh mục đồ uống
        $('#modal .btn-submit').click(function (e) {
            $(this).addClass("disabled");
            e.preventDefault();
            if (!validateModal()) {
                $(this).removeClass("disabled");
                return false;
            }

            var formData = new FormData();

            formData.append("TenDanhMuc", TenDanhMuc);

            $.ajax({
                method: 'POST',
                url: "/QuanTriSP_62134455/ThemDanhMuc",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.status == 1) {
                        $(this).removeClass("disabled");
                        $.toast({
                            heading: 'Thành công',
                            text: res.message,
                            showHideTransition: 'slide',
                            position: 'bottom-right',
                            icon: 'success'
                        })
                        setTimeout(() => {
                            $('#modal .btn-close').click();

                            var newOption = $('<option value="' + res.data.id + '">' + res.data.TenDanhMuc + '</option>');
                            $('#TenDanhMuc').append(newOption);
                        }, 200)
                    }
                    else {
                        $("#submit").removeClass("disabled");
                        $.toast({
                            heading: 'Thông báo',
                            text: res.message,
                            showHideTransition: 'slide',
                            position: 'bottom-right',
                            icon: 'warning'
                        })
                    }
                }
            });
        })

        $('.btn-add-product').click(function (e) {
            e.preventDefault();
            $(this).addClass("disabled");
            if (!validate()) {
                $(this).removeClass("disabled");
                return false;
            }

            var formData = new FormData();

            var files = $("#img-product").get(0).files;

            if (files.length > 0) {
                if (files[0].size > 3 * 1024 * 1024) {
                    $.toast({
                        heading: 'Thông báo',
                        text: 'Kích thước ảnh tối đa là 3 MB',
                        showHideTransition: 'slide',
                        position: 'bottom-right',
                        icon: 'warning'
                    });
                    return false;
                }
                formData.append("HinhAnh", files[0]);
            }
            else {
                $.toast({
                    heading: 'Thông báo',
                    text: 'Bạn phải chọn ảnh',
                    showHideTransition: 'slide',
                    position: 'bottom-right',
                    icon: 'warning'
                });
                return false;
            }

            var TenSanPham = $("input[name='TenSanPham']").val();
            var DonGia = $("input[name='DonGia']").val();
            var sizes = '';
            var checkSize = false;
            $("input[name='Size']:checked").each(function () {
                sizes += $(this).val() + ';';
                checkSize = true;
            });
            if (!checkSize) {
                $('.messageSize').addClass('text-danger').text("Bạn phải chọn ít nhất 1 size đồ uống");
                return false;
            }
            else {
                $('.messageSize').removeClass('text-danger').text("");
            }
            var MoTa = $("textarea[name='Mota']").val();
            var id_danhmuc = $("select[name='TenDanhMuc'] option:selected").val();

            
            formData.append("TenSanPham", TenSanPham);
            formData.append("Gia", DonGia);
            formData.append("Size", sizes);
            formData.append("MoTa", MoTa);
            formData.append("id_danhmuc", id_danhmuc);

            $.ajax({
                method: 'POST',
                url: "/QuanTriSP_62134455/ThemSanPham",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.status == 1) {
                        $.toast({
                            heading: 'Thành công',
                            text: res.message,
                            showHideTransition: 'slide',
                            position: 'bottom-right',
                            icon: 'success'
                        })
                        setTimeout(() => {
                            location.href = "/QuanTriSP_62134455/DanhSachSanPham";
                        }, 1000)
                    }
                    else {
                        $.toast({
                            heading: 'Thông báo',
                            text: res.message,
                            showHideTransition: 'slide',
                            position: 'bottom-right',
                            icon: 'warning'
                        })
                    }
                }
            });

        })
    })
</script>
<form style="padding:30px;">
    <div class="form-group row">
        <label for="inputEmail3" class="col-sm-2 col-form-label">Ảnh (<span class="red">Tối đa 3MB (*)</span>)</label>
        <div class="col-sm-10">
            <div class="dropzone img-upload">
                <input class="mb-1" id="img-product" style="display:none;" type='file' onchange="readURL(this);" />
                <div class="chooseImage" style="height:100px; width: 100px; border: 1px dotted black; border-radius:3px; cursor:pointer">
                    <img height="100" width="100" style="padding:10px;" id="blah" src="~/Assets/icons/upload-icon.svg" alt="your image" />
                </div>
            </div>
        </div>
    </div>
    <div class="form-group row">
        <label for="inputEmail3" class="col-sm-2 col-form-label">Tên sản phẩm (<span class="red">*</span>)</label>
        <div class="col-sm-10">
            <input class="form-control required" name="TenSanPham" placeholder="VD: Coffee muối,...">
            <label class="message"></label>
        </div>
    </div>
    <div class="form-group row">
        <label for="inputPassword3" class="col-sm-2 col-form-label">Đơn giá (<span class="red">*</span>)</label>
        <div class="col-sm-10">
            <input type="number" name="DonGia" class="form-control required">
            <label class="message"></label>
        </div>
    </div>
    <div class="form-group row">
        <div class="col-sm-2">Size (<span class="red">*</span>)</div>
        <div class="col-sm-10">
            <label class="messageSize"></label>
            <div class="form-check">
                <input class="form-check-input" value="s" type="checkbox" name="Size">
                <label class="form-check-label">
                    S
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" value="m" type="checkbox" name="Size">
                <label class="form-check-label">
                    M
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" value="l" type="checkbox" name="Size">
                <label class="form-check-label">
                    L
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" value="big" type="checkbox" name="Size">
                <label class="form-check-label">
                    Khổng lồ
                </label>
            </div>
        </div>
    </div>

    <div class="form-group row">
        <label for="inputPassword3" class="col-sm-2 col-form-label">Mô tả</label>
        <div class="col-sm-10">
            <textarea class="form-control" name="Mota"></textarea>
        </div>
    </div>

    <div class="form-group row">
        <label for="inputPassword3" class="col-sm-2 col-form-label">Loại sản phẩm (<span class="red">*</span>)</label>
        <div class="col-sm-10">
            @Html.DropDownList("TenDanhMuc", new SelectList(ViewBag.DanhMucs, "id", "TenDanhMuc"), new { @class = "form-control" })
            <label class="message"></label>
            <button id="themLoaiSP" class="btn btn-dark mt-1"><i class="icon icon-plus-circle"></i> Thêm Loại</button>
        </div>
    </div>

    <div class="form-group row mt-5">
        <div class="col-sm-10">
            <button type="submit" class="btn btn-success btn-add-product"><i class="icon icon-plus-circle"></i> Thêm mới</button>
        </div>
    </div>




</form>








